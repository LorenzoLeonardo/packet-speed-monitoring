<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Enzo Tech Computer Solutions - LAN Speed Monitor</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #bbdefb;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: #64b5f6;
    }

    th,
    td {
      border: 1px solid #0d47a1;
      padding: 6px 10px;
      text-align: left;
      color: white;
    }

    th {
      background: #0d47a1;
    }

    tbody tr:nth-child(even) {
      background-color: #1976d2;
    }

    h1 {
      color: #0d47a1;
    }

    #tz-select {
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <h1>Enzo Tech Computer Solutions - LAN Speed Monitor</h1>

  <label for="tz-select"><b>Select Timezone:</b></label>
  <select id="tz-select"></select>

  <table id="speed-table">
    <thead>
      <tr>
        <th>IP</th>
        <th>Download</th>
        <th>Upload</th>
        <th>Time</th>
        <th>Timezone</th>
        <th>Max Download</th>
        <th>Max Down Time</th>
        <th>Max Upload</th>
        <th>Max Up Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const evtSource = new EventSource("/events");
    const tbody = document.querySelector("#speed-table tbody");
    const tzSelect = document.querySelector("#tz-select");

    // --- Populate timezone dropdown dynamically ---
    const timeZones = Intl.supportedValuesOf("timeZone");
    const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

    for (const tz of timeZones) {
      const opt = document.createElement("option");
      opt.value = tz;
      opt.textContent = tz;
      if (tz === localTZ) opt.selected = true;
      tzSelect.appendChild(opt);
    }

    let currentTZ = localTZ;
    tzSelect.addEventListener("change", () => {
      currentTZ = tzSelect.value;
      rerenderAllRows(); // refresh table display in new timezone
    });

    const rowDataMap = new Map(); // store latest data per IP for re-rendering

    evtSource.onmessage = (event) => {
      try {
        const batch = JSON.parse(event.data);

        // ‚úÖ Expecting `batch` to be an array of { current, max }
        if (!Array.isArray(batch)) {
          console.warn("Unexpected data format:", batch);
          return;
        }

        for (const data of batch) {
          const curr = data.current;
          const max = data.max;
          const ip = curr.ip;

          // Store data for rerendering later
          rowDataMap.set(ip, data);

          renderRow(ip, curr, max);
        }

        sortTable();
      } catch (err) {
        console.error("Bad JSON", event.data, err);
      }
    };

    function renderRow(ip, curr, max) {
      const dateLocal = new Date(curr.time_local);
      const dateMaxLocal = new Date(max.time_local);

      const opts = {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true,
      };

      const selectedTZTime = dateLocal.toLocaleString("en-US", { ...opts, timeZone: currentTZ });
      const maxDownTimeStr = dateMaxLocal.toLocaleString("en-US", { ...opts, timeZone: currentTZ });
      const maxUpTimeStr = dateMaxLocal.toLocaleString("en-US", { ...opts, timeZone: currentTZ });

      // üìè Helper: format Mbps or Kbps automatically
      const formatSpeed = (mbps) => {
        if (mbps < 1) {
          return `${(mbps * 1000).toFixed(2)} Kbps`;
        }
        return `${mbps.toFixed(3)} Mbps`;
      };

      // üí° Add formatted values
      const down = formatSpeed(curr.mbps_down);
      const up = formatSpeed(curr.mbps_up);
      const maxDown = formatSpeed(max.mbps_down);
      const maxUp = formatSpeed(max.mbps_up);

      const rowHTML = `
        <td>${ip}</td>
        <td>${down}</td>
        <td>${up}</td>
        <td>${selectedTZTime}</td>
        <td>${currentTZ}</td>
        <td>${maxDown}</td>
        <td>${maxDownTimeStr}</td>
        <td>${maxUp}</td>
        <td>${maxUpTimeStr}</td>
      `;

      const existingRow = document.querySelector('tr[data-ip="' + ip + '"]');
      if (existingRow) {
        existingRow.innerHTML = rowHTML;
      } else {
        const row = document.createElement("tr");
        row.setAttribute("data-ip", ip);
        row.innerHTML = rowHTML;
        tbody.appendChild(row);
      }
    }

    function sortTable() {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      rows.sort((a, b) => {
        const ipA = a.getAttribute("data-ip");
        const ipB = b.getAttribute("data-ip");
        return ipA.localeCompare(ipB, undefined, { numeric: true });
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    // üîÅ Re-render all rows when timezone changes
    function rerenderAllRows() {
      for (const [ip, data] of rowDataMap.entries()) {
        renderRow(ip, data.current, data.max);
      }
      sortTable();
    }
  </script>
</body>

</html>