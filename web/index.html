<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Enzo Tech Computer Solutions - LAN Speed Monitor</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #bbdefb;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: #64b5f6;
      border: 4px solid #0d47a1;
    }

    th,
    td {
      border: 1px solid #0d47a1;
      padding: 6px 10px;
      text-align: left;
      color: white;
    }

    th {
      background: #0d47a1;
    }

    tbody tr:nth-child(even) {
      background-color: #1976d2;
    }

    h1 {
      color: #0d47a1;
    }

    #tz-select {
      margin-bottom: 10px;
      padding: 5px;
      font-size: 14px;
    }

    .divider {
      position: relative;
      border-right: none !important; /* avoid inner border overlap */
    }

    .divider::after {
      content: "";
      position: absolute;
      top: 0;
      right: -2px; /* aligns exactly at the table border edge */
      bottom: 0;
      width: 4px; /* thickness of the divider */
      background: #0d47a1; /* same color as your main border */
    }

    /* Hide timezone column completely */
    .hide-col {
      display: none;
    }
  </style>
</head>

<body>
  <h1>Enzo Tech Computer Solutions - LAN Speed Monitor</h1>

  <div style="margin-top: 10px;">
    <button id="start-btn" style="background:#0d47a1; color:white; padding:8px 14px; border:none; border-radius:5px;">Start Listener</button>
    <button id="stop-btn" style="background:#b71c1c; color:white; padding:8px 14px; border:none; border-radius:5px; display:none;">Stop Listener</button>
  </div>

  <label for="tz-select"><b>Select Timezone:</b></label>
  <select id="tz-select"></select>

  <table id="speed-table">
    <thead>
      <tr>
        <th>IP</th>
        <th>Hostname</th>
        <th>Download</th>
        <th>Upload</th>
        <th class="divider">Time</th>
        <th class="hide-col after-timezone">Timezone</th>
        <th>Max Download</th>
        <th>Max Down Time</th>
        <th>Max Upload</th>
        <th>Max Up Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const evtSource = new EventSource("/events");
    const tbody = document.querySelector("#speed-table tbody");
    const tzSelect = document.querySelector("#tz-select");

    // --- Populate timezone dropdown dynamically ---
    const timeZones = Intl.supportedValuesOf("timeZone");
    const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

    for (const tz of timeZones) {
      const opt = document.createElement("option");
      opt.value = tz;
      opt.textContent = tz;
      if (tz === localTZ) opt.selected = true;
      tzSelect.appendChild(opt);
    }

    let currentTZ = localTZ;
    tzSelect.addEventListener("change", () => {
      currentTZ = tzSelect.value;
      rerenderAllRows(); // refresh table display in new timezone
    });

    const rowDataMap = new Map(); // store latest data per IP for re-rendering

    evtSource.onmessage = (event) => {
      try {
        const batch = JSON.parse(event.data);

        // ✅ Expecting `batch` to be an array of { current, max }
        if (!Array.isArray(batch)) {
          console.warn("Unexpected data format:", batch);
          return;
        }

        for (const data of batch) {
          const curr = data.current;
          const max = data.max;
          const ip = curr.ip;

          // Store data for rerendering later
          rowDataMap.set(ip, data);

          renderRow(ip, curr, max);
        }

        sortTable();
      } catch (err) {
        console.error("Bad JSON", event.data, err);
      }
    };

    function renderRow(ip, curr, max) {
      // Parse UTC times from backend
      const dateUTC = new Date(curr.time_utc);
      const dateMaxDownUTC = max.time_utc_down ? new Date(max.time_utc_down) : null;
      const dateMaxUpUTC = max.time_utc_up ? new Date(max.time_utc_up) : null;

      const opts = {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true,
      };

      const formatDate = (date) =>
        date ? date.toLocaleString("en-US", { ...opts, timeZone: currentTZ }) : "—";

      const selectedTZTime = formatDate(dateUTC);
      const maxDownTimeStr = formatDate(dateMaxDownUTC);
      const maxUpTimeStr = formatDate(dateMaxUpUTC);

      const formatSpeed = (mbps) => (mbps < 1
        ? `${(mbps * 1000).toFixed(2)} Kbps`
        : `${mbps.toFixed(3)} Mbps`
      );

      const rowHTML = `
        <td>${ip}</td>
        <td>${curr.hostname}</td>
        <td>${formatSpeed(curr.mbps_down)}</td>
        <td>${formatSpeed(curr.mbps_up)}</td>
        <td class="divider">${selectedTZTime}</td>
        <td class="hide-col after-timezone">${currentTZ}</td>
        <td>${formatSpeed(max.mbps_down)}</td>
        <td>${maxDownTimeStr}</td>
        <td>${formatSpeed(max.mbps_up)}</td>
        <td>${maxUpTimeStr}</td>
      `;

      const existingRow = document.querySelector('tr[data-ip="' + ip + '"]');
      if (existingRow) {
        existingRow.innerHTML = rowHTML;
      } else {
        const row = document.createElement("tr");
        row.setAttribute("data-ip", ip);
        row.innerHTML = rowHTML;
        tbody.appendChild(row);
      }
    }

    function sortTable() {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      rows.sort((a, b) => {
        const ipA = a.getAttribute("data-ip");
        const ipB = b.getAttribute("data-ip");
        return ipA.localeCompare(ipB, undefined, { numeric: true });
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    // 🔁 Re-render all rows when timezone changes
    function rerenderAllRows() {
      for (const [ip, data] of rowDataMap.entries()) {
        renderRow(ip, data.current, data.max);
      }
      sortTable();
    }

 // --- Control buttons logic ---
    // --- Start/Stop Packet Listener Buttons ---
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");

    async function toggleButtons(running) {
      startBtn.style.display = running ? "none" : "inline-block";
      stopBtn.style.display = running ? "inline-block" : "none";
    }

    // Check initial listener state
    async function checkStatus() {
      try {
        const res = await fetch("/status");
        const data = await res.json();
        toggleButtons(data.running);
      } catch (err) {
        console.error("Failed to get status", err);
      }
    }

    startBtn.addEventListener("click", async () => {
      await fetch("/start", { method: "POST" });
      toggleButtons(true);
    });

    stopBtn.addEventListener("click", async () => {
      await fetch("/stop", { method: "POST" });
      toggleButtons(false);
    });

    checkStatus(); // run once on load
  </script>
</body>

</html>