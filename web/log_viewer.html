<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Real-Time Log Viewer</title>
    <style>
        /* === MobaXterm-like Dark Terminal Theme === */
        body {
            background-color: #1e1e1e;
            color: #cccccc;
            font-family: "Consolas", "Courier New", monospace;
            margin: 0;
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #00ff87;
            font-weight: 400;
            margin-bottom: 8px;
            font-size: 18px;
            text-shadow: 0 0 6px #00ff87;
        }

        #log-box {
            background-color: #0c0c0c;
            border: 1px solid #2a2a2a;
            border-radius: 5px;
            padding: 10px;
            color: #cccccc;
            white-space: pre-wrap;
            overflow-y: auto;
            flex: 1;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: inset 0 0 15px #000;
        }

        /* Scrollbar (MobaXterm-like) */
        #log-box::-webkit-scrollbar {
            width: 10px;
        }

        #log-box::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 10px;
        }

        #log-box::-webkit-scrollbar-thumb:hover {
            background-color: #666;
        }

        /* === Log Level Colors (ANSI-like) === */
        .log-debug {
            color: #5f87ff;
        }

        .log-info {
            color: #bfbfbf;
        }

        .log-warning {
            color: #ffd75f;
        }

        .log-error {
            color: #ff5f5f;
        }

        .log-critical {
            color: #ff0000;
            font-weight: bold;
        }

        .log-success {
            color: #5fff5f;
        }

        /* Cursor effect */
        #cursor {
            display: inline-block;
            width: 8px;
            background-color: #00ff87;
            animation: blink 1s step-start infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <h1>ðŸ“œ Real-Time Log Output</h1>
    <div id="log-box" style="white-space: pre-wrap; overflow-y: auto; height: 90vh;">
        {{LOG_CONTENT}}<span id="cursor"></span>
    </div>

    <script>
        const logBox = document.getElementById('log-box');
        const evtSource = new EventSource('/log_event');

        function getLogClass(line) {
            if (/\b(ERROR|ERR)\b/i.test(line)) return "log-error";
            if (/\b(WARN|WARNING)\b/i.test(line)) return "log-warning";
            if (/\b(DEBUG)\b/i.test(line)) return "log-debug";
            if (/\b(CRITICAL|FATAL)\b/i.test(line)) return "log-critical";
            if (/\b(OK|SUCCESS|DONE)\b/i.test(line)) return "log-success";
            if (/\b(INFO)\b/i.test(line)) return "log-info";
            return "";
        }

        function applyColorToExistingLogs() {
            // Get the raw innerText from the server-rendered log
            const rawText = logBox.innerText.replace(/â–Š$/, '');
            const lines = rawText.split(/\r?\n/);

            // Clear the box
            logBox.innerHTML = "";

            // Re-insert each line with proper color
            lines.forEach(line => {
                if (line.trim() === "") return;
                const span = document.createElement("span");
                const logClass = getLogClass(line);
                if (logClass) span.classList.add(logClass);
                span.textContent = line + "\n";
                logBox.appendChild(span);
            });

            // Re-attach blinking cursor
            const cursor = document.createElement("span");
            cursor.id = "cursor";
            logBox.appendChild(cursor);

            // Scroll to bottom
            logBox.scrollTop = logBox.scrollHeight;
        }

        window.addEventListener('load', () => {
            applyColorToExistingLogs();
        });

        evtSource.onmessage = (e) => {
            const cursor = document.getElementById("cursor");
            if (cursor) cursor.remove();

            const line = e.data;
            const span = document.createElement("span");
            const logClass = getLogClass(line);
            if (logClass) span.classList.add(logClass);
            span.textContent = line + "\n";
            logBox.appendChild(span);

            logBox.scrollTop = logBox.scrollHeight;

            const newCursor = document.createElement("span");
            newCursor.id = "cursor";
            logBox.appendChild(newCursor);
        };

        evtSource.onerror = (e) => {
            console.error("SSE connection lost.", e);
        };
    </script>
</body>

</html>